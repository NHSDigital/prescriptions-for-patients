<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<VerifyHeaders async="false" continueOnError="false" enabled="true" name="FlowCallout.VerifyHeaders">
    <Step>
        <Name>OauthV2.VerifyAccessTokenP9</Name>
    </Step>
    <Step>
        <Name>DecodeJWT.DecodeIdToken</Name>
    </Step>
    <Step>
        <Name>AssignMessage.AddPatientAccessHeader</Name>
    </Step>
    {% if ALLOW_NHS_NUMBER_OVERRIDE %}
    <Step>
        <Name>AssignMessage.OverridePatientAccessHeader</Name>
        <Condition>(request.header.X-NHS-NUMBER != null)</Condition>
    </Step>
    {% endif %}
    <Step>
        <!-- Header NHSD-Request-ID must be in the correct format (GUID) -->
        <Name>RaiseFault.400MissingHeader</Name>
        <Condition>(not original-request-details.header.X-Request-ID ~~ "^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$")</Condition>
    </Step>
</VerifyHeaders>
